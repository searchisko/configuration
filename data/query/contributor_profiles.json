{
  "id" : "contributor_profiles",
  "description" : "Query contributor profiles. Accepts the following parameters: 'query', 'contributor'.",
  "default" : {
    "sys_type" : "contributor_profile"
  },
  "override" : {
    "sys_content_type" : "source"
  },
  "template" : "{\n    {{#total}} \"size\":  0, {{/total}}\n    {{^total}} \"size\": 30, {{/total}}\n    \"fields\": [ \"sys_contributors\", \"sys_title\", \"sys_url_view\" ],\n    \"script_fields\": {\n      \"accounts\": {\n        \"script\": \"(_source.accounts && _source.accounts.length > 0 ) ? _source.accounts[0] : ''\"\n      }\n    },\n    \"query\": {\n      \"filtered\": {\n        \"filter\" : {\n          \"and\": {\n            \"filters\": [\n              {{#contributor}}\n              {\n                \"terms\": {\n                  \"sys_contributors\": [\n                    {{#contributor}}\n                    \"{{.}}\",\n                    {{/contributor}}\n                    {}\n                  ]\n                }\n              },\n              {{/contributor}}\n              {{#date_from}}\n              {\n                \"range\": {\n                  \"sys_created\": {\n                    \"gte\": \"{{date_from}}\",\n                    \"time_zone\" : \"{{timezone_offset}}{{^timezone_offset}}America/New_York{{/timezone_offset}}\"\n                  }\n                }\n              },\n              {{/date_from}}\n              {{#date_to}}\n              {\n                \"range\": {\n                  \"sys_created\": {\n                    \"lt\": \"{{date_to}}\",\n                    \"time_zone\" : \"{{timezone_offset}}{{^timezone_offset}}America/New_York{{/timezone_offset}}\"\n                  }\n                }\n              },\n              {{/date_to}}\n              {}\n            ]\n          }\n        },\n        \"query\": {\n          {{#query}}\n          \"simple_query_string\": {\n            \"fields\": [\"sys_contributors.fulltext\", \"sys_title\"],\n            \"query\": \"{{query}}\",\n            \"default_operator\": \"and\"\n          }\n          {{/query}}\n          {{^query}}\n          \"match_all\": {}\n          {{/query}}\n        }\n      }\n    }\n    {{#aggregate}}\n    ,\n    \"aggs\" : {\n      \"bucketed\" : {\n        \"date_histogram\" : {\n          \"field\" : \"{{date_field}}{{^date_field}}sys_created{{/date_field}}\",\n          \"interval\" : \"{{interval}}{{^interval}}month{{/interval}}\",\n          \"format\": \"{{bucket_key_format}}{{^bucket_key_format}}yyyy-MM{{/bucket_key_format}}\",\n          \"pre_zone\" : \"{{timezone_offset}}{{^timezone_offset}}America/New_York{{/timezone_offset}}\"\n        },\n        \"aggs\" : {\n          \"by_kpi\" : { \n            \"terms\" : { \n              \"field\" : \"regInfo.kpi\",\n                \"size\" : \"0\"\n            }\n          }\n          {{#by_country}}\n          ,\"by_country\" : {\n              \"terms\" : { \n                \"field\" : \"country\",\n                \"size\" : \"0\"\n              }\n          }\n          {{/by_country}}\n          {{#by_company}}\n          ,\"by_company\" : { \n            \"terms\" : {\n              \"field\" : \"company\",\n              \"size\" : \"0\"\n            }\n          }\n          {{/by_company}}\n        }\n      }\n    }\n    {{/aggregate}}\n}"
}
